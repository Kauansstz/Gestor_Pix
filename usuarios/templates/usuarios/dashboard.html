{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Ol√°, {{ request.user.username }} üëã</h1>

    <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4">
            <a href="#" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded font-semibold">
                Atualizar Dashboard üîÑ
            </a>
            <a href="{% url 'usuarios:exportar_transacoes' %}" 
            class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded font-semibold">
            Exportar CSV
            </a>
        </div>

        <a href="{% url 'usuarios:logout' %}" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded font-semibold">
            Sair
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gr√°fico linear -->
        <div class="bg-white rounded shadow p-6 flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Crescimento L√≠quido (√öltimos 7 dias)</h2>
            <canvas id="lineChart"></canvas>
        </div>

        <!-- Tabela di√°ria de entradas e sa√≠das -->
        <div class="bg-white rounded shadow p-6">
            <h2 class="text-2xl font-bold mb-4">Transa√ß√µes Di√°rias</h2>
            <table class="w-full border-collapse border text-center">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border px-4 py-2">Data</th>
                        <th class="border px-4 py-2">Entradas (R$)</th>
                        <th class="border px-4 py-2">Sa√≠das (R$)</th>
                        <th class="border px-4 py-2">Crescimento L√≠quido (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transacoes_diarias %}
                    <tr class="hover:bg-gray-100">
                        <td class="border px-4 py-2">{{ t.data }}</td>
                        <td class="border px-4 py-2">R$ {{ t.entrada }}</td>
                        <td class="border px-4 py-2">R$ {{ t.saida }}</td>
                        <td class="border px-4 py-2">R$ {{ t.crescimento}}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="border px-4 py-2">Nenhuma transa√ß√£o encontrada</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="mt-4">
                <div><span class="font-semibold">Total Entradas:</span> R$ {{ total_entrada }}</div>
                <div><span class="font-semibold">Total Sa√≠das:</span> R$ {{ total_saida }}</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ labels_json|safe }};
    const entradas = {{ entradas_json|safe }};
    const saidas = {{ saidas_json|safe }};
    const crescimento = {{ crescimento_json|safe }};

    const ctx = document.getElementById('lineChart').getContext('2d');

    const lineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Crescimento L√≠quido',
                    data: crescimento,
                    borderColor: '#2563EB',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#2563EB',
                    pointBorderColor: '#2563EB',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointStyle: 'circle'
                },
                {
                    label: 'Entradas',
                    data: entradas,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#10B981',
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'Sa√≠das',
                    data: saidas,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#EF4444',
                    pointBorderColor: '#EF4444',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + context.raw.toFixed(2);
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { return 'R$ ' + value.toFixed(2); }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
